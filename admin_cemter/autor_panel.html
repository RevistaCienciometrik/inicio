<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autores - Revista Cienciometrik</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="autor_panel.css">
</head>
<body>
    <mi-header></mi-header>
    <div class="container">
        <aside class="sidebar">
            <h3>Panel de Autor</h3>
            <nav>
                <ul>
                    <li><a href="#enviar-articulo"><i class="fas fa-paper-plane"></i> Enviar Artículo</a></li>
                    <li><a href="#mis-articulos"><i class="fas fa-file-alt"></i> Mis Artículos</a></li>
                    <li><a href="#observaciones"><i class="fas fa-comment-dots"></i> Observaciones</a></li>
                    <li><a href="#articulos-eliminados"><i class="fas fa-trash-restore"></i> Mis Artículos Eliminados</a></li>
                    <li id="logout-btnn">
                        <a href="#"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
                    </li>                    
                </ul>
            </nav>
        </aside>
        <main class="main-content">
            <section class="section author-hero">
                <div class="author-hero-content">
                    <i class="fas fa-user-edit author-icon"></i>
                    <h2>SECCIÓN DE AUTORES</h2>
                    <p class="subtitle">Envía tus contribuciones, sigue el estado de tus artículos y participa activamente en el proceso de revisión.</p>
                </div>
            </section>
            <section id="enviar-articulo" class="section submit-article-section">
                <h2><i class="fas fa-paper-plane"></i> Enviar Nuevo Artículo</h2>
                <p>Recuerda que artículo debe ser original, inédito y basado en información veraz, citando siempre todas las fuentes y autores adecuadamente para evitar el plagio. La contribución de cada autor debe ser significativa y transparente, garantizando así la integridad y calidad académica que nuestra revista promueve.</p>
                <p>Completa este formulario para enviar tu artículo a revisión.</p>
                <form id="submission-form" class="modern-form">
                    <div class="form-group">
                        <label for="tituloArticulo"><i class="fas fa-heading icon"></i> Título del Artículo: (Máximo 25 palabras)</label>
                        <input type="text" id="tituloArticulo" required>
                    </div>
                    <div class="form-group">
                        <label for="autorNombre"><i class="fas fa-user icon"></i> Tu Nombre Completo:</label>
                        <input type="text" id="autorNombre" required>
                    </div>
                    <div class="form-group">
                        <label for="autorEmail"><i class="fas fa-envelope icon"></i> Tu Correo Electrónico:</label>
                        <input type="email" id="autorEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="contenidoArticulo"><i class="fas fa-file-alt icon"></i> Contenido del Artículo: (Con palabras clave, resumen, nombre completo de autor(es) y referencias)</label>
                        <textarea id="contenidoArticulo" rows="15" required placeholder="Pega o escribe aquí el contenido completo de tu artículo..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="observaciones"><i class="fas fa-comment-alt icon"></i> Observaciones Adicionales (opcional):</label>
                        <textarea id="observaciones" rows="5" placeholder="Cualquier nota, aclaración o mensaje para los revisores..."></textarea>
                    </div>
                    <br>
                    <a href="https://drive.google.com/drive/folders/1CWcmaeNfji335XACO76MLwtonVAImtfZ?usp=drive_link" target="_blank" class="submit-button">
                    <i class="fas fa-upload"></i> Doc Upload
                    </a>
                    <p>Sube tu PDF aquí.</p>
                    <br>
                    <a href="https://docs.google.com/document/d/1z_dtXeqZtzpCusfiq0vI74_tryxKOuQ8/edit?usp=drive_link&ouid=110401971620638453579&rtpof=true&sd=true" target="_blank" class="submit-button">
                        <i class="fas fa-upload"></i> Plantilla Oficial
                    </a>                    
                    <p>Visita este enlace para descargar la plantilla para documentar tu articulo en documento word.</p>
                    
                    <div id="mensaje-envio" class="mensaje"></div>
                    <br>
                    <button type="submit" class="submit-button"><i class="fas fa-upload"></i> Enviar Artículo</button>
                    <p>¡Envíanos el texto de tu artículo para revisión! </p>
                </form>
            </section>
            <section id="mis-articulos" class="section my-articles-section">
                <h2><i class="fas fa-file-alt"></i> Mis Artículos Enviados</h2>
                <p>Consulta el estado de tus artículos y las revisiones.</p>
                <div class="search-bar">
                    <label for="search-autor-email"><i class="fas fa-envelope icon"></i>Ingresa tu correo electrónico y haz clic en "Buscar Mis Artículos" para verlos aquí.</label>
                    <input type="email" id="search-autor-email" placeholder="tu_correo@example.com" required>
                    <button id="btn-buscar-articulos" class="submit-button small-button">
                        <i class="fas fa-search"></i> Buscar Mis Artículos
                    </button>
                    <button id="btn-limpiar-busqueda" class="button-secondary small-button">
                        <i class="fas fa-eraser"></i> Limpiar Búsqueda
                    </button>
                </div>
                <div id="lista-mis-articulos" class="articles-list">
                    <p class="loading-message"></p>
                </div>
                <div id="mensaje-mis-articulos" class="mensaje"></div>
            </section>
            <section id="observaciones" class="section observations-section">
                <h2><i class="fas fa-comment-dots"></i> Envíanos tus Observaciones</h2>
                <p>Tus comentarios son importantes para mejorar nuestra revista.</p>
                <form id="observations-form" class="modern-form">
                    <div class="form-group">
                        <label for="observation-name"><i class="fas fa-user icon"></i> Tu Nombre:</label>
                        <input type="text" id="observation-name" required>
                    </div>
                    <div class="form-group">
                        <label for="observation-email"><i class="fas fa-envelope icon"></i> Tu Correo Electrónico:</label>
                        <input type="email" id="observation-email" required class="modern-form-input">
                    </div>
                    <div class="form-group">
                        <label for="observation-message"><i class="fas fa-comment-dots icon"></i> Tu Observación/Sugerencia:</label>
                        <textarea id="observation-message" rows="5" required></textarea>
                    </div>
                    <button type="submit" class="submit-button"><i class="fas fa-paper-plane"></i> Enviar Observación</button>
                    <div id="mensaje-observaciones" class="mensaje"></div>
                </form>
            </section>
            <section id="articulos-eliminados" class="section deleted-articles-section">
                <h2><i class="fas fa-trash-restore"></i> Mis Artículos Eliminados</h2>
                <p>Aquí puedes ver los artículos que has eliminado y recuperarlos si lo deseas.</p>
                <div class="search-bar">
                    <label for="search-deleted-email"><i class="fas fa-envelope icon"></i> Ingresa tu correo electrónico y haz clic en "Buscar Eliminados" para ver tus artículos ocultos aquí.</label>
                    <input type="email" id="search-deleted-email" placeholder="tu_correo@example.com" required>
                    <button id="btn-buscar-eliminados" class="submit-button small-button">
                        <i class="fas fa-search"></i> Buscar Eliminados
                    </button>
                </div>
                <div id="lista-articulos-eliminados" class="articles-list">
                    <p class="loading-message"></p>
                </div>
                <div id="mensaje-articulos-eliminados" class="mensaje"></div>
            </section>
        </main>
    </div>
    <mi-footer></mi-footer>

    

    <script>
    // Verificar si el usuario está autenticado
    document.addEventListener('DOMContentLoaded', () => {
        checkAuthentication();
        
        // Mostrar información del usuario
        const userEmail = getUserEmail();
        const userRole = getUserRole();
        
        // Puedes mostrar esta información en la página si lo deseas
        console.log(`Usuario: ${userEmail}, Rol: ${userRole}`);
    });
    </script>

    <script src="auth.js"></script>
    <script src="header_admin.js"></script>
    <script src="../Objects/container.js"></script>
    <script src="footer_admin.js"></script>
    <script src="../Objects/script.js?v=1.0"></script> 
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, updateDoc, serverTimestamp, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAuRQC65O5zlkNbcnp1srZkQpjmD82TVco",
            authDomain: "cienciometrik-3c8e7.firebaseapp.com",
            projectId: "cienciometrik-3c8e7",
            storageBucket: "cienciometrik-3c8e7.firebasestorage.app",
            messagingSenderId: "60232446009",
            appId: "1:60232446009:web:1ce1cbb0437018d62f9de8"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        // --- REFERENCIAS A ELEMENTOS DEL DOM ---
        const submissionForm = document.getElementById('submission-form');
        const tituloArticuloInput = document.getElementById('tituloArticulo');
        const autorNombreInput = document.getElementById('autorNombre');
        const autorEmailInput = document.getElementById('autorEmail');
        const contenidoArticuloInput = document.getElementById('contenidoArticulo');
        const observacionesInput = document.getElementById('observaciones');
        const mensajeEnvio = document.getElementById('mensaje-envio');
        const searchAutorEmailInput = document.getElementById('search-autor-email');
        const btnBuscarArticulos = document.getElementById('btn-buscar-articulos');
        const btnLimpiarBusqueda = document.getElementById('btn-limpiar-busqueda');
        const listaMisArticulos = document.getElementById('lista-mis-articulos');
        const mensajeMisArticulos = document.getElementById('mensaje-mis-articulos');
        const observationsForm = document.getElementById('observations-form');
        const observationNameInput = document.getElementById('observation-name');
        const observationEmailInput = document.getElementById('observation-email');
        const observationMessageInput = document.getElementById('observation-message');
        const mensajeObservaciones = document.getElementById('mensaje-observaciones');
        const searchDeletedEmailInput = document.getElementById('search-deleted-email');
        const btnBuscarEliminados = document.getElementById('btn-buscar-eliminados');
        const listaArticulosEliminados = document.getElementById('lista-articulos-eliminados');
        const mensajeArticulosEliminados = document.getElementById('mensaje-articulos-eliminados');
        
        // --- VARIABLES PARA LA MODAL (NUEVO) ---
        const modalArticulo = document.getElementById('modal-articulo');
        const modalTitulo = document.getElementById('modal-titulo');
        const modalAutor = document.getElementById('modal-autor');
        const modalEmail = document.getElementById('modal-email');
        const modalFechaEnvio = document.getElementById('modal-fecha-envio');
        const modalFechaRecepcion = document.getElementById('modal-fecha-recepcion');
        const modalEstado = document.getElementById('modal-estado');
        const modalContenido = document.getElementById('modal-contenido');
        const modalComentariosRevisor = document.getElementById('modal-comentarios-revisor');
        const modalRespuestaAutor = document.getElementById('modal-respuesta-autor');
        const modalGuardarComentario = document.getElementById('modal-guardar-comentario');
        const modalCerrar = document.getElementById('modal-cerrar');
        const modalMensaje = document.getElementById('modal-mensaje');
        
        let autorEmailConsultado = '';
        let currentArticleId = null; // Para almacenar el ID del artículo actual en la modal
        
        // --- FUNCIÓN PARA ABRIR LA MODAL (NUEVO) ---
        function openArticleModal(articleData, docId) {
            currentArticleId = docId;
            
            // Llenar datos en la modal
            modalTitulo.textContent = articleData.tituloArticulo || 'Título no disponible';
            modalAutor.textContent = articleData.autorNombre || 'Autor no disponible';
            modalEmail.textContent = articleData.autorEmail || 'Correo no disponible';
            
            // Formatear fechas
            const fechaEnvio = articleData.fechaEnvioFirebase && articleData.fechaEnvioFirebase.seconds 
                ? new Date(articleData.fechaEnvioFirebase.seconds * 1000).toLocaleDateString('es-ES') 
                : 'N/A';
            const fechaRecepcion = articleData.fechaRecepcionFirebase && articleData.fechaRecepcionFirebase.seconds 
                ? new Date(articleData.fechaRecepcionFirebase.seconds * 1000).toLocaleDateString('es-ES') 
                : 'N/A';
            
            modalFechaEnvio.textContent = fechaEnvio;
            modalFechaRecepcion.textContent = fechaRecepcion;
            
            // Estado con formato
            let estadoTexto;
            if (articleData.aprobadoRevisor === true) {
                estadoTexto = 'Aprobado';
                modalEstado.className = 'status-aprobado';
            } else if (articleData.aprobadoRevisor === false) {
                estadoTexto = 'Rechazado';
                modalEstado.className = 'status-rechazado';
            } else {
                estadoTexto = 'Pendiente de Revisión';
                modalEstado.className = 'status-pendiente';
            }
            modalEstado.textContent = estadoTexto;
            
            // Contenido del artículo
            modalContenido.textContent = articleData.contenidoArticulo || 'Contenido no disponible';
            
            // Comentarios del revisor
            modalComentariosRevisor.textContent = articleData.comentariosRevisor || '';
            
            // Respuesta del autor
            modalRespuestaAutor.value = articleData.respuestaAutorAComentarios || '';
            
            // Limpiar mensajes anteriores
            modalMensaje.textContent = '';
            modalMensaje.style.color = '';
            
            // Mostrar la modal
            modalArticulo.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Evitar scroll en el fondo
        }
        
        // --- MANEJADOR DE ENVÍO DE ARTÍCULO ---
        submissionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            mensajeEnvio.textContent = 'Enviando artículo...';
            mensajeEnvio.style.color = 'blue';
            const tituloArticulo = tituloArticuloInput.value.trim();
            const autorNombre = autorNombreInput.value.trim();
            const autorEmail = autorEmailInput.value.trim();
            const contenidoArticulo = contenidoArticuloInput.value.trim();
            const observaciones = observacionesInput.value.trim();
            if (!tituloArticulo || !autorNombre || !autorEmail || !contenidoArticulo) {
                mensajeEnvio.textContent = 'Por favor, completa todos los campos obligatorios.';
                mensajeEnvio.style.color = 'red';
                return;
            }
            try {
                await addDoc(collection(db, "articulosEnviados"), {
                    tituloArticulo,
                    autorNombre,
                    autorEmail,
                    contenidoArticulo,
                    observaciones,
                    fechaEnvioFirebase: serverTimestamp(), // Fecha de subida del autor
                    fechaRecepcionFirebase: serverTimestamp(), // Asume que se recibe al instante
                    aprobadoRevisor: null, // Inicialmente nulo (pendiente de revisión)
                    comentariosRevisor: '', // Inicialmente vacío
                    respuestaAutorAComentarios: '', // Nuevo campo para respuesta del autor
                    estado: 'Pendiente de Revisión',
                    oculto: false // Para ocultar o mostrar artículos según necesidad del revisor
                });
                mensajeEnvio.textContent = 'Artículo enviado exitosamente. ¡Gracias por tu contribución!';
                mensajeEnvio.style.color = 'green';
                submissionForm.reset(); // Limpiar el formulario después del envío
                // Si el email actual coincide con el consultado, recargar sus artículos
                if (autorEmail === autorEmailConsultado) {
                    await cargarArticulos(autorEmailConsultado, false);
                }
            } catch (error) {
                console.error("Error al enviar el artículo: ", error);
                mensajeEnvio.textContent = `Error al enviar el artículo: ${error.message}. Por favor, inténtalo de nuevo.`;
                mensajeEnvio.style.color = 'red';
            }
        });
        
        // --- FUNCIÓN PARA CARGAR ARTÍCULOS DEL AUTOR (visibles u ocultos) ---
        async function cargarArticulos(email, oculto = false) {
            const targetList = oculto ? listaArticulosEliminados : listaMisArticulos;
            const targetMessage = oculto ? mensajeArticulosEliminados : mensajeMisArticulos;
            targetMessage.textContent = `Cargando tus artículos${oculto ? ' eliminados' : ''}...`;
            targetMessage.style.color = 'blue';
            targetList.innerHTML = ''; // Limpiar lista anterior
            try {
                const q = query(
                    collection(db, "articulosEnviados"),
                    where("autorEmail", "==", email),
                    where("oculto", "==", oculto) // Filtra por el campo 'oculto'
                );
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    targetMessage.textContent = `No se encontraron artículos${oculto ? ' eliminados' : ''} para este correo electrónico.`;
                    targetMessage.style.color = 'orange';
                    return;
                }
                let htmlContent = '';
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const docId = doc.id;
                    const fechaEnvio = data.fechaEnvioFirebase && data.fechaEnvioFirebase.seconds ? new Date(data.fechaEnvioFirebase.seconds * 1000).toLocaleDateString('es-ES') : 'N/A';
                    const fechaRecepcion = data.fechaRecepcionFirebase && data.fechaRecepcionFirebase.seconds ? new Date(data.fechaRecepcionFirebase.seconds * 1000).toLocaleDateString('es-ES') : 'N/A';
                    const fechaRevision = data.fechaRevisionRevisor && data.fechaRevisionRevisor.seconds ? new Date(data.fechaRevisionRevisor.seconds * 1000).toLocaleDateString('es-ES') : 'N/A';
                    
                    let estadoClase;
                    let estadoTexto;
                    if (data.aprobadoRevisor === true) {
                        estadoClase = 'status-aprobado';
                        estadoTexto = 'Aprobado por el Admin/Revisor';
                    } else if (data.aprobadoRevisor === false) {
                        estadoClase = 'status-rechazado';
                        estadoTexto = 'Rechazado por el Admin y/o el Revisor: Revisar comentarios y editar articulo';
                    } else {
                        estadoClase = 'status-pendiente-de-revision';
                        estadoTexto = 'Pendiente de Revisión';
                    }
                    // Determinar si el artículo es editable (solo si está rechazado)
                    const isEditable = data.aprobadoRevisor === false; // Solo editable si está rechazado
                    htmlContent += `
                        <div class="article-card">
                            <h3>${data.tituloArticulo || 'Título no disponible'}</h3>
                            <p><strong>Estado:</strong> <span class="${estadoClase}">${estadoTexto}</span></p>
                            <p><strong>Fecha Envío:</strong> ${fechaEnvio}</p>
                            ${data.fechaRecepcionFirebase ? `<p><strong>Fecha Recepción en Firebase:</strong> ${fechaRecepcion}</p>` : ''}
                            ${data.fechaRevisionRevisor ? `<p><strong>Fecha Última Revisión:</strong> ${fechaRevision}</p>` : ''}
                            ${data.oculto ? `<p><strong>Visibilidad:</strong> <span class="status-rechazado">Oculto</span></p>` : ''}
                            
                            <div class="article-actions">
                                <button class="view-article-btn" data-id="${docId}" data-target-list="${oculto ? 'deleted' : 'visible'}">
                                    <i class="fas fa-eye"></i> Ver Contenido
                                </button>
                                ${isEditable && !oculto ? `
                                    <button class="edit-article-btn" data-id="${docId}">
                                        <i class="fas fa-edit"></i> Editar Artículo
                                    </button>
                                ` : ''}
                                ${!oculto ? `
                                    <button class="delete-article-btn" data-id="${docId}">
                                        <i class="fas fa-trash-alt"></i> Eliminar artículo
                                    </button>
                                ` : `
                                    <button class="restore-article-btn" data-id="${docId}">
                                        <i class="fas fa-undo-alt"></i> Recuperar artículo
                                    </button>
                                `}
                            </div>
                            <div id="full-article-${docId}" class="full-article-content" style="display:none;">
                                <h4>Contenido Completo:</h4>
                                <textarea id="edit-content-${docId}" rows="15" ${!isEditable ? 'readonly' : ''}>${data.contenidoArticulo || 'Contenido no disponible'}</textarea>
                                
                                <h4>Título:</h4>
                                <input type="text" id="edit-title-${docId}" value="${data.tituloArticulo || ''}" ${!isEditable ? 'readonly' : ''}>
                                
                                <h4>Observaciones del Autor:</h4>
                                <textarea id="edit-observaciones-${docId}" rows="5" ${!isEditable ? 'readonly' : ''}>${data.observaciones || ''}</textarea>
                                ${data.comentariosRevisor ? `
                                    <h4>Comentarios:</h4>
                                    <div class="revisor-comment-box">
                                        <p>${data.comentariosRevisor}</p>
                                    </div>
                                ` : ''}
                                <h4>Observaciones:</h4>
                                <textarea id="author-response-${docId}" rows="5" placeholder="Escribe aquí tus observaciones...">${data.respuestaAutorAComentarios || ''}</textarea>
                                
                                <div class="review-actions">
                                    ${isEditable && !oculto ? `
                                        <button class="save-edit-btn" data-id="${docId}"><i class="fas fa-save"></i> Guardar Cambios</button>
                                    ` : ''}
                                    ${!oculto ? `
                                        <button class="save-response-btn" data-id="${docId}"><i class="fas fa-reply"></i> Guardar Respuesta</button>
                                    ` : ''}
                                    <button class="close-article-btn" data-target-list="${oculto ? 'deleted' : 'visible'}"><i class="fas fa-times"></i> Cerrar</button>
                                </div>
                                <div id="mensaje-articulo-${docId}" class="mensaje"></div>
                            </div>
                        </div>
                    `;
                });
                targetList.innerHTML = htmlContent;
                targetMessage.textContent = ''; // Limpiar mensaje de carga
                
                // --- Añadir Event Listeners para los botones de artículo ---
                // Usamos event delegation para mejorar el rendimiento
                targetList.addEventListener('click', async (event) => {
                    const target = event.target;
                    const button = target.closest('button');
                    if (!button) return;
                    
                    const articleId = button.dataset.id;
                    const targetListType = button.dataset.targetList;
                    
                    if (button.classList.contains('view-article-btn')) {
                        // Obtener datos del artículo desde Firebase
                        try {
                            const articleRef = doc(db, "articulosEnviados", articleId);
                            const articleSnap = await getDoc(articleRef);
                            
                            if (articleSnap.exists()) {
                                const articleData = articleSnap.data();
                                openArticleModal(articleData, articleId);
                            } else {
                                console.error("No se encontró el artículo");
                                alert("No se pudo cargar el artículo. Inténtalo de nuevo.");
                            }
                        } catch (error) {
                            console.error("Error al obtener el artículo: ", error);
                            alert("Error al cargar el artículo. Inténtalo de nuevo.");
                        }
                    } else if (button.classList.contains('close-article-btn')) {
                        const fullArticleDiv = button.closest('.full-article-content');
                        if (fullArticleDiv) {
                            const articleId = fullArticleDiv.id.replace('full-article-', '');
                            fullArticleDiv.style.display = 'none';
                            const viewButton = targetList.querySelector(`.view-article-btn[data-id="${articleId}"][data-target-list="${targetListType}"]`);
                            if (viewButton) {
                                viewButton.style.display = 'inline-block';
                            }
                        }
                    } else if (button.classList.contains('edit-article-btn') && !oculto) {
                        const fullArticleDiv = document.getElementById(`full-article-${articleId}`);
                        if (fullArticleDiv) {
                            fullArticleDiv.style.display = 'block';
                            button.style.display = 'none'; // Ocultar "Editar Artículo"
                        }
                    } else if (button.classList.contains('save-edit-btn') && !oculto) {
                        const newTitle = document.getElementById(`edit-title-${articleId}`).value;
                        const newContent = document.getElementById(`edit-content-${articleId}`).value;
                        const newObservaciones = document.getElementById(`edit-observaciones-${articleId}`).value;
                        
                        if (confirm('¿Estás seguro de que quieres guardar los cambios en el artículo y reenviarlo para revisión?')) {
                            await updateArticleAndResubmit(articleId, newTitle, newContent, newObservaciones, `mensaje-articulo-${articleId}`);
                        }
                    } else if (button.classList.contains('save-response-btn') && !oculto) {
                        const authorResponse = document.getElementById(`author-response-${articleId}`).value;
                        
                        if (confirm('¿Estás seguro de que quieres guardar tu respuesta al revisor?')) {
                            await updateAuthorResponse(articleId, authorResponse, `mensaje-articulo-${articleId}`);
                        }
                    } else if (button.classList.contains('delete-article-btn') && !oculto) {
                        const email = searchAutorEmailInput.value.trim();
                        if (confirm('¿Estás seguro de que quieres eliminar este artículo? Se moverá a la sección de artículos eliminados.')) {
                            await deleteArticle(articleId, email, `mensaje-articulo-${articleId}`);
                        }
                    } else if (button.classList.contains('restore-article-btn') && oculto) {
                        const email = searchDeletedEmailInput.value.trim();
                        if (confirm('¿Estás seguro de que quieres recuperar este artículo? Se moverá a la sección de artículos activos.')) {
                            await restoreArticle(articleId, email, `mensaje-articulo-${articleId}`);
                        }
                    }
                });
            } catch (error) {
                console.error("Error al cargar los artículos del autor: ", error);
                targetMessage.textContent = `Error al cargar tus artículos: ${error.message}. Asegúrate de tener conexión a Firebase y reglas de seguridad adecuadas.`;
                targetMessage.style.color = 'red';
            }
        }
        
        // --- FUNCIÓN PARA ACTUALIZAR EL ARTÍCULO Y REENVIAR A REVISIÓN ---
        async function updateArticleAndResubmit(docId, newTitle, newContent, newObservaciones, messageDivId) {
            const messageDiv = document.getElementById(messageDivId);
            messageDiv.textContent = '';
            messageDiv.style.color = 'initial';
            try {
                const articleRef = doc(db, "articulosEnviados", docId);
                await updateDoc(articleRef, {
                    tituloArticulo: newTitle,
                    contenidoArticulo: newContent,
                    observaciones: newObservaciones,
                    aprobadoRevisor: null, // Vuelve a pendiente de revisión
                    comentariosRevisor: '', // Borra comentarios anteriores si el autor edita
                    fechaRecepcionFirebase: serverTimestamp(), // Actualiza la fecha de recepción (re-envío)
                    estado: 'Pendiente de Revisión - Reenvío' // Nuevo estado para indicar reenvío
                });
                messageDiv.textContent = 'Artículo actualizado y reenviado para revisión exitosamente.';
                messageDiv.style.color = 'green';
                await cargarArticulos(autorEmailConsultado, false); // Recargar la lista para reflejar cambios
            } catch (error) {
                console.error("Error al actualizar el artículo y reenviar: ", error);
                messageDiv.textContent = `Error al actualizar el artículo: ${error.message}`;
                messageDiv.style.color = 'red';
            }
        }
        
        // --- FUNCIÓN PARA SOLO ACTUALIZAR LA RESPUESTA DEL AUTOR ---
        async function updateAuthorResponse(docId, authorResponse, messageDivId) {
            const messageDiv = document.getElementById(messageDivId);
            messageDiv.textContent = '';
            messageDiv.style.color = 'initial';
            try {
                const articleRef = doc(db, "articulosEnviados", docId);
                await updateDoc(articleRef, {
                    respuestaAutorAComentarios: authorResponse,
                });
                messageDiv.textContent = 'Tu respuesta ha sido guardada exitosamente.';
                messageDiv.style.color = 'green';
                // No es necesario recargar toda la lista, solo el mensaje.
            } catch (error) {
                console.error("Error al guardar la respuesta del autor: ", error);
                messageDiv.textContent = `Error al guardar tu respuesta: ${error.message}`;
                messageDiv.style.color = 'red';
            }
        }
        
        // --- FUNCIÓN PARA ELIMINAR ARTÍCULO (MOVER A ELIMINADOS) ---
        async function deleteArticle(docId, autorEmail, messageDivId) {
            const messageDiv = document.getElementById(messageDivId);
            messageDiv.textContent = 'Eliminando artículo...';
            messageDiv.style.color = 'blue';
            try {
                const articleRef = doc(db, "articulosEnviados", docId);
                await updateDoc(articleRef, {
                    oculto: true,
                    fechaEliminacion: serverTimestamp()
                });
                messageDiv.textContent = 'Artículo eliminado exitosamente. Ahora aparece en la sección de artículos eliminados.';
                messageDiv.style.color = 'green';
                // Recargar ambas listas
                await cargarArticulos(autorEmail, false); // Recargar artículos activos
                await cargarArticulos(autorEmail, true); // Recargar artículos eliminados
            } catch (error) {
                console.error("Error al eliminar el artículo: ", error);
                messageDiv.textContent = `Error al eliminar el artículo: ${error.message}`;
                messageDiv.style.color = 'red';
            }
        }
        
        // --- FUNCIÓN PARA RECUPERAR ARTÍCULO (MOVER A ACTIVOS) ---
        async function restoreArticle(docId, autorEmail, messageDivId) {
            const messageDiv = document.getElementById(messageDivId);
            messageDiv.textContent = 'Recuperando artículo...';
            messageDiv.style.color = 'blue';
            try {
                const articleRef = doc(db, "articulosEnviados", docId);
                await updateDoc(articleRef, {
                    oculto: false,
                    fechaRecuperacion: serverTimestamp()
                });
                messageDiv.textContent = 'Artículo recuperado exitosamente. Ahora aparece en la sección de artículos activos.';
                messageDiv.style.color = 'green';
                // Recargar ambas listas
                await cargarArticulos(autorEmail, false); // Recargar artículos activos
                await cargarArticulos(autorEmail, true); // Recargar artículos eliminados
            } catch (error) {
                console.error("Error al recuperar el artículo: ", error);
                messageDiv.textContent = `Error al recuperar el artículo: ${error.message}`;
                messageDiv.style.color = 'red';
            }
        }
        
        // --- MANEJADOR DE ENVÍO DE OBSERVACIONES ---
        observationsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            mensajeObservaciones.textContent = 'Enviando observación...';
            mensajeObservaciones.style.color = 'blue';
            const name = observationNameInput.value.trim();
            const email = observationEmailInput.value.trim();
            const message = observationMessageInput.value.trim();
            if (!name || !email || !message) {
                mensajeObservaciones.textContent = 'Por favor, completa todos los campos.';
                mensajeObservaciones.style.color = 'red';
                return;
            }
            try {
                await addDoc(collection(db, "observacionesAutores"), {
                    name,
                    email,
                    message,
                    timestamp: serverTimestamp()
                });
                mensajeObservaciones.textContent = 'Observación enviada exitosamente. ¡Gracias!';
                mensajeObservaciones.style.color = 'green';
                observationsForm.reset();
            } catch (error) {
                console.error("Error al enviar la observación: ", error);
                mensajeObservaciones.textContent = `Error al enviar la observación/sugerencia: ${error.message}. Asegúrate de tener conexión y reglas de Firebase correctas para 'observacionesAutores'.`;
                mensajeObservaciones.style.color = 'red';
            }
        });
        
        // --- EVENT LISTENERS PARA LA MODAL (NUEVO) ---
        modalCerrar.addEventListener('click', () => {
            modalArticulo.style.display = 'none';
            document.body.style.overflow = ''; // Restaurar scroll
            currentArticleId = null;
        });

        // Cerrar modal al hacer clic fuera del contenido
        window.addEventListener('click', (event) => {
            if (event.target === modalArticulo) {
                modalArticulo.style.display = 'none';
                document.body.style.overflow = '';
                currentArticleId = null;
            }
        });

        // Guardar comentario/respuesta del autor
        modalGuardarComentario.addEventListener('click', async () => {
            if (!currentArticleId) return;
            
            const respuesta = modalRespuestaAutor.value.trim();
            
            try {
                const articleRef = doc(db, "articulosEnviados", currentArticleId);
                await updateDoc(articleRef, {
                    respuestaAutorAComentarios: respuesta
                });
                
                modalMensaje.textContent = 'Tu respuesta ha sido guardada exitosamente.';
                modalMensaje.style.color = 'green';
                
                // Actualizar el artículo en la lista si está visible
                if (autorEmailConsultado) {
                    await cargarArticulos(autorEmailConsultado, false);
                }
            } catch (error) {
                console.error("Error al guardar la respuesta del autor: ", error);
                modalMensaje.textContent = `Error al guardar tu respuesta: ${error.message}`;
                modalMensaje.style.color = 'red';
            }
        });
        
        // --- EVENTO DEL BOTÓN DE BÚSQUEDA DE ARTÍCULOS ---
        btnBuscarArticulos.addEventListener('click', async () => {
            const email = searchAutorEmailInput.value.trim();
            if (email) {
                autorEmailConsultado = email; // Guarda el email consultado
                await cargarArticulos(autorEmailConsultado, false); // Cargar artículos no ocultos
            } else {
                alert("Por favor, introduce un correo electrónico para buscar tus artículos.");
            }
        });
        
        btnLimpiarBusqueda.addEventListener('click', async () => {
            searchAutorEmailInput.value = '';
            listaMisArticulos.innerHTML = '<p class="loading-message">Ingresa tu correo electrónico y haz clic en "Buscar Mis Artículos" para verlos aquí.</p>';
            mensajeMisArticulos.textContent = '';
            autorEmailConsultado = '';
        });
        
        // --- EVENTO DEL BOTÓN DE BÚSQUEDA DE ARTÍCULOS ELIMINADOS ---
        btnBuscarEliminados.addEventListener('click', async () => {
            const email = searchDeletedEmailInput.value.trim();
            if (email) {
                await cargarArticulos(email, true); // Cargar artículos ocultos
            } else {
                alert("Por favor, introduce un correo electrónico para buscar tus artículos eliminados.");
            }
        });
        
        // --- CARGA INICIAL DE ARTÍCULOS AL CARGAR LA PÁGINA (VACÍA AL PRINCIPIO) ---
        // La carga inicial se disparará solo cuando el usuario ingrese un email y haga clic en el botón.
        document.addEventListener('DOMContentLoaded', async () => {
            // No llamar a cargarArticulos aquí para que el usuario deba buscar.
        });
    </script>

    <!-- Ventana Modal para Visualizar Artículo -->
    <div id="modal-articulo" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-titulo">Título del Artículo</h3>
                <div class="modal-info">
                    <p><strong>Autor:</strong> <span id="modal-autor"></span></p>
                    <p><strong>Correo:</strong> <span id="modal-email"></span></p>
                    <p><strong>Fecha Envío:</strong> <span id="modal-fecha-envio"></span></p>
                    <p><strong>Fecha Recepción:</strong> <span id="modal-fecha-recepcion"></span></p>
                    <p><strong>Estado:</strong> <span id="modal-estado"></span></p>
                </div>
            </div>
            <div class="modal-body">
                <h4>Contenido Completo:</h4>
                <div id="modal-contenido" class="modal-articulo-contenido"></div>
                
                <h4>Comentarios del Revisor:</h4>
                <div id="modal-comentarios-revisor" class="modal-comentarios"></div>
                
                <h4>Tu Respuesta:</h4>
                <textarea id="modal-respuesta-autor" rows="5" placeholder="Escribe aquí tus observaciones..."></textarea>
            </div>
            <div class="modal-footer">
                <button id="modal-guardar-comentario" class="submit-button">
                    <i class="fas fa-save"></i> Guardar Comentario
                </button>
                <button id="modal-cerrar" class="button-secondary">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
            <div id="modal-mensaje" class="mensaje"></div>
        </div>
    </div>
</body>
</html>